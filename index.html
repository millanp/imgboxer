<!DOCTYPE html>
<html>
  <head>
    <link href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-1.11.3.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>JS Bin</title>

  <style id="jsbin-css">
@import url(https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css);
img, div.thumbnail {
  max-width: 100%;
}
.instructions p {
  display: inline-block;
}
canvas {
  display: none;
}
.selection-square {
  width: 30px;
  height: 30px;
  border: 1px solid;
  position: absolute;
  background-color: rgba(255, 0, 0, 0.3);
  z-index: 0;
/*   background-image: url(http://pre08.deviantart.net/4c4b/th/pre/f/2011/094/d/a/drawing_grid_by_blossomhillstables-d3d70y5.png);
  background-repeat: repeat;
  background-size: 519px 384.5px; */
}
.selection-square:focus, .selection-square:active {
  outline: none;
  z-index: 1;
}
.selection-square:focus {
  background-color: rgba(0, 255, 0, 0.3);
}
.selection-square:active {
  background-color: rgba(255, 165, 0, 0.3);
}
#selectorImage {
  height: 75vh;
}

/* .selection-square::before {
  content: "âœ˜";
  margin-top: -1em;
  position: absolute;
} */
#downloadLink {
  display: none;
}
highlighting-panel {
  margin: 10px;
}
classify-panel {
  margin: 10px;
}
.image-grid {
  display: flex;
  flex-wrap: wrap;
  flex-grow: 7;
}
.tag-list {
  flex-grow: 3;
  margin-left: auto;
}
.btn:focus {
  outline: none;
}
.tag-btn {
  color: #eeeeee;
}
.selection-widget {
  display: flex;
}
.thumbnail {
  height: 100px;
  width: 100px;
  background-size: cover;
  border: 3px solid white;
  transition: all 0.25s;
}
.thumbnail.ui-selected {
  border: 3px solid blue;
}
.thumbnail.ui-selecting {
  border: 3px solid orange;
}
filepicking-panel {
  padding: 10px;
}
highlighting-panel, classify-panel {
  display: none;
}
</style>
</head>
  <body>
    <filepicking-panel>
      <form id="dirSelectorForm">
        <p><input id="files" type="file" webkitdirectory directory multiple name="dir"></p>
        <p><input type="submit" class="btn btn-primary"></p>
      </form>
    </filepicking-panel>
    <highlighting-panel>
      <img src="http://placehold.it/600x600" id="selectorImage">  

      <p>
        <button id="prevButton" class="btn btn-default">Previous</button>
        <button id="nextButton" class="btn btn-default">Next</button>
      </p>
      <p>
        <button id="getDownloadLink" class="btn btn-success">
          Get download link
        </button>
        <a id="downloadLink" download="data.json">
          Click here
        </a>
      </p>
      <p>
        <button id="classifyButton" class="btn btn-primary">
          Go to tagging view
        </button>
      </p>
      <div class="instructions">
        <p>
          U = Previous image
        </p>
        <p>
          I = Next image
        </p>
        <p>
          O = Shrink selection
        </p>
        <p>
          P = Grow selection
        </p>
        <canvas id="cropper"></canvas>

      </div>
    </highlighting-panel>
    <classify-panel>
      <div class="selection-widget">
        <div class="image-grid">

        </div>
        <div class="tag-list btn-group-vertical" role="group" aria="...">
          Tags here
        </div>
      </div>
      <div class="lower-area">
        <button id="boxButton" class="btn btn-primary">
          Go to boxing view
        </button>
      </div>

    </classify-panel>
  <script id="jsbin-javascript">
// STABLE
// noprotect
var $f = $('#dirSelectorForm');
var selectorImage = $('#selectorImage')[0];
var el = document.getElementById;
var imgDimensions = [600, 600];
var defaultSquareRadius = 20;
var radiusResizeIncrement = 10;
// Change this to a non-hidden file for easier access
var labelsFileName = '.labels';
var tagsHaveLoaded = false;
var buffer = 5; // Images before and after currently viewed one to store in memory

function range(end) {
  var result = [];
  for (var i = 0; i < end; i++)
    result[i] = i;
  return result;
}

$f.submit(function(e) {
  e.preventDefault();
  var fileList = document.getElementById('files').files;
  var imageList = [];
  var fl = fileList.length;
  controller.writeTagSet([]);
  var file;
  for (var i = 0; i < fl; i++) {
    file = fileList[i];
    var reader = new FileReader();
    if (file.name == labelsFileName) {
      reader.onload = function(e) {
        var trimmed = $.trim(e.target.result);
        var tags = trimmed.split('\n');
        controller.writeTagSet(tags);
        tagsHaveLoaded = true;
      }
      reader.readAsText(file);
    } else {
      imageList.push(file);
    }

  }

  for (var j = 0; j < imageList.length; j++) {
    file = imageList[j];
//     var imgReader = new FileReader();
//     imgReader.onload = (function(index, totalExpected, name) {
//       return function(e) {
//         if (controller.addURL(e.target.result, index, totalExpected, name)) {
//           controller.switchToView(highlightView);
//         }
//       }
//     })(j, imageList.length, file.name);
//     imgReader.readAsDataURL(file);
    controller.addImg(file, j, name);
  }
  controller.switchToView(highlightView);
});

var model = {
  dataURLs: {imageCount: 0},
  loadedSoFar: 0,
  init: function() {
    console.log(model.loadedSoFar);
  },
  get: function() {
    return this.dataURLs;
  },
  getURL: function(n) {
    return this.get()[n].url;
  },
  getFile: function(n) {
    try {
      return this.get()[n].file;
    } catch (e) {
      return null;
    }
    
  },
  getLoadedSoFar: function() {
    return model.loadedSoFar;
  },
  addTagToImgRect: function(tagId, imgId, rectId) {
    model.dataURLs[imgId].rects[rectId].tag = tagId;
  },
  setURL: function(url, n, imageCount) {
    model.loadedSoFar++;
    this.dataURLs[n] = {url: url, rects: [], tags: []};
    this.dataURLs.imageCount = imageCount;
  },
  setFile: function(file, n, imageCount) {
    model.loadedSoFar++;
    this.dataURLs[n] = {file: file, rects: [], tags: []};
    this.dataURLs.imageCount++;
  },
  getName: function(n) {
    return this.get()[n].name;
  },
  setName: function(name, n) {
    this.get()[n].name = name;
  },
  setRect: function(n, trueRect) {
    if (!this.dataURLs[n])
      this.dataURLs[n] = { rects: trueRect };
    else
      this.dataURLs[n].rects = trueRect;
  },
  writeTagSet: function(tagSet) {
    this.dataURLs.tags = tagSet;
  },
  getTagSet: function() {
    return this.dataURLs.tags;
  },
  getTagString: function(tagId) {
    return this.dataURLs.tags[tagId];
  },
  getLength: function() {
    return this.dataURLs.imageCount;
  }
}
var view; // Current view
var filepickingView = {
  panel: $('filepicking-panel'),
  init: function() {
    this.panel.css('display', 'block');
  },
  deinit: function() {
    this.panel.css('display', 'none');
  }
};
var highlightView = {
  currImage: 0,
  initialized: false,
  panel: $('highlighting-panel'),
  init: function() {
    controller.startInitBuffer(0);
    this.panel.css('display', 'block');
    view.applyRectModifiers();
    if (!this.initialized) {
      this.bindEvents();
      this.render();
      this.initialized = true;
    }
  },
  bindEvents: function() {
    $('#nextButton').click(function(event) {
      controller.storeRect(view.currImage);
      view.resetAllRects(true);
      console.log('next0');
      console.log(view.currImage);
      console.log(controller.getLength());
      if (view.currImage+1 < controller.getLength()) {
        view.currImage++;
        console.log('shifting window');
        controller.shiftWindow(1);
      }

      view.render();
    });
    $('#prevButton').click(function(event) {
      controller.storeRect(view.currImage);
      if (view.currImage-1 >= 0) {
        view.currImage--;
        controller.shiftWindow(-1);
      }
      view.render();
    });
    $('#classifyButton').click(function(event) {
      controller.storeRect(view.currImage);
      controller.switchToView(classifyView);
    });
    $('#addRectButton').click(function(event) {
      controller.addRect();
    });
    $('#getDownloadLink').click(function(event) {
      controller.showDownloadLink();
    });
    $('#selectorImage').click(function(event) {
      console.log('adding rect');
      view.addRectCenteredAt(event.pageX, event.pageY, defaultSquareRadius);
    });
    $(document).keydown(function(event) {
      function subtractRadius(ind, val) {
        return parseFloat(val) - radiusResizeIncrement;
      }
      function subtract2Radius(ind, val) {
        return subtractRadius(0, subtractRadius(ind, val));
      }
      function addRadius(ind, val) {
        return parseFloat(val) + radiusResizeIncrement;
      }
      function add2Radius(ind, val) {
        return addRadius(0, addRadius(ind, val));
      }
      switch (event.which) {
        case 80: // 'p'
          $('.selection-square:focus').css('top', subtractRadius)
            .css('left', subtractRadius)
            .css('width', add2Radius)
            .css('height', add2Radius);
          break;
        case 79: // 'o'
          $('.selection-square:focus').css('top', addRadius)
            .css('left', addRadius)
            .css('width', subtract2Radius)
            .css('height', subtract2Radius);
          break;
        case 73: // 'i'
          $('#nextButton').click();
          break;
        case 85: // 'u'
          $('#prevButton').click();
          break;
        case 222: // "'"
          $('#getDownloadLink').click();
          break;
        case 13: // "enter"
          $('#downloadLink').click();
          break;
      }
    });
    $('.selection-square').dblclick(function(event) {
      this.remove();
    });
  },

  deinit: function() {
    this.panel.hide();
  },
  dataUrlOfCrop: function(rect) {
    var cvv = $('#cropper')[0];
    var img = $('#selectorImage')[0];
    cvv.width = rect.width;
    cvv.height = rect.height;
    var cv = cvv.getContext('2d');
    cv.drawImage(img, rect.left, rect.top, rect.width, rect.height, 0, 0, cvv.width, cvv.height);
    return cvv.toDataURL();
  },
  getRects: function() {
    controller.resetDimensions();
    var $sqs = $('.selection-square');
    var rects = [];
    $sqs.each(function(i) {
      var $sq = $(this);
      var pos = $sq.offset();
      pos.left = view.rx(pos.left);
      pos.top = view.ry(pos.top);
      var rect = {
        top: pos.top * imgDimensions[1] / selectorImage.height,
        left: pos.left * imgDimensions[0] / selectorImage.width,
        width: parseFloat($sq.css('width')) * imgDimensions[0] / selectorImage.width,
        height: parseFloat($sq.css('height')) * imgDimensions[1] / selectorImage.height,
      };
      rect.url = view.dataUrlOfCrop(rect);
      rect.realWidth = parseFloat($sq.css('width'));
      rect.realHeight = parseFloat($sq.css('height'));
      rects.push(rect);
    });
    return rects;
  },
  setRects: function() {
    view.resetAllRects(true);
    var imgObj = controller.getImageObject(view.currImage);
    var panel = $('highlighting-panel');
    var rect;
    for (var i = 0; i < imgObj.rects.length; i++) {
      rect = imgObj.rects[i];
      var newRect = $('<div class="selection-square"></div>');
      newRect.css({
        'width': view.realToScaledX(rect.width),
        'height': view.realToScaledY(rect.height),
        'top': view.storedToTrueY(rect.top),
        'left': view.storedToTrueX(rect.left),
      });
      panel.prepend(newRect);
    }
    view.applyRectModifiers();
  },
  addRectCenteredAt: function(x, y, radius) {
    var trueLeft = x - radius;
    var trueTop = y - radius;
    view.drawAndFocusRect(trueLeft, trueTop, radius * 2, radius * 2);
  },
  drawAndFocusRect: function(x, y, width, height) {
    var toPrepend = $('<div class="selection-square"></div>');
    toPrepend.css({
      'width': width,
      'height': height,
      'top': y,
      'left': x,
    });
    $('highlighting-panel').prepend(toPrepend);
    setTimeout(function() {
      toPrepend.get(0).focus();
    }, 10);

    view.applyRectModifiers();
  },
  showDownloadLink: function(url) {
    $('#downloadLink').attr('href', url);
    $('#downloadLink').show();
  },
  render: function() {
    $('#selectorImage').attr('src', controller.getURL());
    view.setRects();
  },
  rx: function(x) {
    return x - selectorImage.offsetLeft;
  },
  ry: function(y) {
    console.log('using scrollTop')
    return y - selectorImage.offsetTop;
  },
  trueX: function(x) {
    return x + selectorImage.offsetLeft;
  },
  trueY: function(y) {
    return y + selectorImage.offsetTop;
  },
  realToScaledX: function(dim) {
    controller.resetDimensions();
    return dim * selectorImage.width / imgDimensions[0];
  },
  scaledToRealX: function(dim) {
    controller.resetDimensions();
    return dim * imgDimensions[0] / selectorImage.width;
  },
  realToScaledY: function(dim) {
    controller.resetDimensions();
    return dim * selectorImage.height / imgDimensions[1];
  },
  scaledToRealY: function(dim) {
    controller.resetDimensions();
    return dim * imgDimensions[1] / selectorImage.height;
  },
  storedToTrueX: function(dim) {
    return view.trueX(view.realToScaledX(dim));
  },
  storedToTrueY: function(dim) {
    return view.trueY(view.realToScaledY(dim));
  },
  addRect: function() {
    $('highlighting-panel').prepend(
      '<div class="selection-square"></div>'
    );
    view.applyRectModifiers();
  },
  applyRectModifiers: function() {
    $('.selection-square').draggable().resizable();
    $('.selection-square').dblclick(function(event) {
      this.remove();
    });
    $('.selection-square').attr('tabindex', '-1');
  },
  resetAllRects: function(noAdd) {
    $('.selection-square').each(function(index) {
      $(this).remove();
    });
    if (!noAdd)
      view.addRect();
  }
};
var classifyView = {
  panel: $('classify-panel'),
  init: function() {
    this.panel.css('display', 'block');
    
    this.render();
    this.applyModifiers();
    this.applyEventHandlers();
  },
  deinit: function() {
    this.panel.css('display', 'none');
  },
  render: function() {
    var grid = $('.image-grid');
    grid.empty();
    for (var n = 0; n < controller.getLength(); n++) {
      console.log('imaging');
      for (var i = 0, rects = controller.rectsForImg(n); i < rects.length; i++) {
        var thumbnail = $('<div class="thumbnail" data-tooltip="No tags set"></div>');
        thumbnail.attr('data-imgid', n);
        thumbnail.attr('data-rectid', i);
        thumbnail.css({
          'height': rects[i].realHeight * 2,
          'width': rects[i].realWidth * 2,
        });
        grid.append(thumbnail);
        thumbnail.css('background-image', u.cssURL(rects[i].url));

      }
    }
    var tagList = $('.tag-list');
    tagList.empty();
    controller.getTagSet().forEach(function(tag, id) {
      var tagSpan = $('<button class="btn btn-default tag-btn"></button>');
      tagSpan.text(tag);
      tagSpan.attr('data-tagid', id);
      tagList.append(tagSpan);
      tagSpan.css('color', 'white');
      tagSpan.css('background-color', u.getColor(id));
    });
  },
  tagBtn: function(tagString, tagId) {
    var tagSpan = $('<button class="btn btn-default tag-btn"></button>');
    tagSpan.text(tagString);
    tagSpan.attr('data-tagid', tagId);
    tagSpan.css('background-color', u.getColor(tagId));
    return tagSpan;
  },
  realToScaledX: function(x) {
    return $('.image-grid').attr('width') / 10;
  },
  renderTooltip: function(thumbId) {
    var thumbElem = view.getThumb(thumbId);
    var tooltipContent = "";
    controller.tagsForImage(thumbId).forEach(function(tagId) {
      tooltipContent += view.tagBtn(controller.tagString(tagId), tagId)[0].outerHTML;
    });
    thumbElem.attr('data-tooltip', tooltipContent);
    thumbElem.tooltip();
  },
  getThumb: function(id) {
    return $('.thumb[data-imgid=' + id + ']');
  },
  addTagToThumbnail: function(tagElem, thumbElem) {
//     var newTitle = thumbElem.attr('data-tooltip') + tagElem[0].outerHTML;
//     console.log('new title '+newTitle);
//     thumbElem.attr('data-tooltip', newTitle);
//     thumbElem.tooltip();
    thumbElem.remove();
//     Eventually make this add HTML to display tag BADGE, not just text
  },
  tagSelected: function(tagElem) {
    $('.ui-selected').each(function() {
      controller.applyTagToThumbnail(tagElem, $(this));
    });
  },
  applyModifiers: function() {
    $.widget("ui.tooltip", $.ui.tooltip, {
      options: {
        content: function () {
          return $(this).attr('data-tooltip');
        }
      }
    });
    $('.image-grid').selectable();
    $('.thumbnail').each(function() {
      $(this).tooltip();
    });
  },
  applyEventHandlers: function() {
    $('.tag-btn').click(function(event) {
      view.tagSelected($(this));
    });
    $('#boxButton').click(function(event) {
      controller.switchToView(highlightView);
    });
  }
};
var u = {
  COLORS: [
    "A32929", "B1365F", "7A367A", "5229A3", "29527A", "2952A3", "1B887A",
    "28754E", "0D7813", "528800", "88880E", "AB8B00", "BE6D00", "B1440E",
    "865A5A", "705770", "4E5D6C", "5A6986", "4A716C", "6E6E41", "8D6F47",
    "853104", "691426", "5C1158", "23164E", "182C57", "060D5E", "125A12",
    "2F6213", "2F6309", "5F6B02", "875509", "8C500B", "754916", "6B3304",
    "5B123B", "42104A", "113F47", "333333", "0F4B38", "856508", "711616",
  ],
  cssURL: function(url) {
    return 'url(' + url + ')';
  },
  getRandomColor: function() {
    // 30 random hues with step of 12 degrees
    var hue = Math.floor(Math.random() * 30) * 12;

    return $.Color({
      hue: hue,
      saturation: 0.9,
      lightness: 0.6,
      alpha: 1
    }).toHexString();
  },
  getColor: function(n) {
    return '#'+u.COLORS[n];
  }

};
var controller = {
  fileToUrlMap: {},
  loadedSoFar: 0,
  fileWindow: [],
  bufferLoaded: false,
  bufferCenterModelId: 0,
  init: function() {
    view = filepickingView;
    model.init();
    view.init();
  },
  startInitBuffer: function(n) {
    for (var i = n-buffer, j=0; i < n+buffer; i++, j++) {
      if (model.getFile(i)) {
        this.fileWindow.push(model.getFile(i));
      } else {
        this.fileWindow.push(null);
      }
    }
    for (var i = 0; i < this.fileWindow.length; i++) {
      var file = this.fileWindow[i];
      if (file) {
        var fr = new FileReader();
        fr.onload = controller.addToMapFunction(file);
        console.log('reading file '+file.name);
        fr.readAsDataURL(file);
      } else {
        controller.fileToUrlMap[null] = null;
      }
    }
  },
  switchToView: function(newView) {
    view.deinit();
    view = newView;
    newView.init();
  },
  getURL: function() {
    console.log(this.fileWindow[buffer].webkitRelativePath);
    console.log(this.fileToUrlMap[this.fileWindow[buffer].webkitRelativePath].substr(0, 8))
    return this.fileToUrlMap[this.fileWindow[buffer].webkitRelativePath];    
  },
  addToMapFunction: function(file) {
    return function(e) {
      console.log('writing file '+file.name);
      controller.fileToUrlMap[file.webkitRelativePath] = e.target.result;
    }
  },
  readToMap: function(file) {
    var fr = new FileReader();
    fr.onload = this.addToMapFunction(file);
    fr.readAsDataURL(file);
  },
  shiftWindow: function(dir) {
    var fl;
    if (dir > 0) {
      fl = model.getFile(this.bufferCenterModelId + buffer);
      this.fileWindow.push(fl);
      // ADD ACTUAL FILE READING HERE
      this.readToMap(fl)
      this.bufferCenterModelId++;
      delete this.fileToUrlMap[this.fileWindow.shift().webkitRelativePath];
    } else if (dir < 0) {
      fl = model.getFile(this.bufferCenterModelId - buffer - 1);
      this.fileWindow.unshift(fl);
      this.readToMap(fl);
      this.bufferCenterModelId--;
      delete this.fileToUrlMap[this.fileWindow.pop().webkitRelativePath];
    }
  },
  getNextURL: function(dir) {
    this.shiftWindow(dir);
    return this.getURL();
  },
  addURL: function(url, n, totalExpected, name) {
    model.setURL(url, n, totalExpected);
    model.setName(name, n);
    if (model.getLoadedSoFar() == totalExpected) {
      return true; // for processDone
    }
  },
  addImg: function(file, n, name) {
    model.setFile(file, n);
    model.setName(name, n);
  },
  getImageObject: function(n) {
    return model.get()[n];
  },
  getLength: function() {
    return model.getLength();
  },
  storeRect: function(n) {
    model.setRect(n, view.getRects());
  },
  //   addRect: function() {
  //     view.addRect();
  //   },
  showDownloadLink: function() {
    // to copy it completely
    var writeObject = JSON.parse(JSON.stringify(model.get()));
    delete writeObject.tags;
    for (var n in writeObject) {
      if (!isNaN(n)) {
        var img = writeObject[n];
        for (var j in img.rects) {
          delete img.rects[j].url;
          img.rects[j].tag = model.getTagString(img.rects[j].tag);
        }
        delete writeObject[n].url;
      }
    }
    
    var url = 'data:application/json,' + 
        encodeURIComponent(JSON.stringify(writeObject));
    view.showDownloadLink(url);
  },
  resetDimensions: function() {
    $('#selectorImage').css('max-width', 'initial');
    imgDimensions[0] = selectorImage.width;
    imgDimensions[1] = selectorImage.height;
    $('#selectorImage').css('max-width', '100%');
  },
  writeTagSet: function(tagSet) {
    model.writeTagSet(tagSet);
  },
  getTagSet: function() {
    return model.getTagSet();
  },
  tagsForImg: function(n) {
    return model.get()[n].tags;
  },
  rectsForImg: function(n) {
    return model.get()[n].rects;
  },
  tagStrings: function(ids) {
    var strings = [];
    ids.forEach(function (id) {
      strings.push(model.getTagString(id));
    })
    return strings;
  },
  applyTagToThumbnail: function(tagElem, thumb) {
    var imgId = thumb.attr('data-imgid');
    var rectId = thumb.attr('data-rectid');
    var tagId = tagElem.attr('data-tagid');
    model.addTagToImgRect(tagId, imgId, rectId);
    view.addTagToThumbnail(tagElem, thumb);
  }
}
controller.init();
</script>


<script id="jsbin-source-css" type="text/css">@import url(https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css);
img, div.thumbnail {
  max-width: 100%;
}
.instructions p {
  display: inline-block;
}
canvas {
  display: none;
}
.selection-square {
  width: 30px;
  height: 30px;
  border: 1px solid;
  position: absolute;
  background-color: rgba(255, 0, 0, 0.3);
  z-index: 0;
/*   background-image: url(http://pre08.deviantart.net/4c4b/th/pre/f/2011/094/d/a/drawing_grid_by_blossomhillstables-d3d70y5.png);
  background-repeat: repeat;
  background-size: 519px 384.5px; */
}
.selection-square:focus, .selection-square:active {
  outline: none;
  z-index: 1;
}
.selection-square:focus {
  background-color: rgba(0, 255, 0, 0.3);
}
.selection-square:active {
  background-color: rgba(255, 165, 0, 0.3);
}
#selectorImage {
  height: 75vh;
}

/* .selection-square::before {
  content: "âœ˜";
  margin-top: -1em;
  position: absolute;
} */
#downloadLink {
  display: none;
}
highlighting-panel {
  margin: 10px;
}
classify-panel {
  margin: 10px;
}
.image-grid {
  display: flex;
  flex-wrap: wrap;
  flex-grow: 7;
}
.tag-list {
  flex-grow: 3;
  margin-left: auto;
}
.btn:focus {
  outline: none;
}
.tag-btn {
  color: #eeeeee;
}
.selection-widget {
  display: flex;
}
.thumbnail {
  height: 100px;
  width: 100px;
  background-size: cover;
  border: 3px solid white;
  transition: all 0.25s;
}
.thumbnail.ui-selected {
  border: 3px solid blue;
}
.thumbnail.ui-selecting {
  border: 3px solid orange;
}
filepicking-panel {
  padding: 10px;
}
highlighting-panel, classify-panel {
  display: none;
}</script>

<script id="jsbin-source-javascript" type="text/javascript">// STABLE
// noprotect
var $f = $('#dirSelectorForm');
var selectorImage = $('#selectorImage')[0];
var el = document.getElementById;
var imgDimensions = [600, 600];
var defaultSquareRadius = 20;
var radiusResizeIncrement = 10;
// Change this to a non-hidden file for easier access
var labelsFileName = '.labels';
var tagsHaveLoaded = false;
var buffer = 5; // Images before and after currently viewed one to store in memory

function range(end) {
  var result = [];
  for (var i = 0; i < end; i++)
    result[i] = i;
  return result;
}

$f.submit(function(e) {
  e.preventDefault();
  var fileList = document.getElementById('files').files;
  var imageList = [];
  var fl = fileList.length;
  controller.writeTagSet([]);
  var file;
  for (var i = 0; i < fl; i++) {
    file = fileList[i];
    var reader = new FileReader();
    if (file.name == labelsFileName) {
      reader.onload = function(e) {
        var trimmed = $.trim(e.target.result);
        var tags = trimmed.split('\n');
        controller.writeTagSet(tags);
        tagsHaveLoaded = true;
      }
      reader.readAsText(file);
    } else {
      imageList.push(file);
    }

  }

  for (var j = 0; j < imageList.length; j++) {
    file = imageList[j];
//     var imgReader = new FileReader();
//     imgReader.onload = (function(index, totalExpected, name) {
//       return function(e) {
//         if (controller.addURL(e.target.result, index, totalExpected, name)) {
//           controller.switchToView(highlightView);
//         }
//       }
//     })(j, imageList.length, file.name);
//     imgReader.readAsDataURL(file);
    controller.addImg(file, j, name);
  }
  controller.switchToView(highlightView);
});

var model = {
  dataURLs: {imageCount: 0},
  loadedSoFar: 0,
  init: function() {
    console.log(model.loadedSoFar);
  },
  get: function() {
    return this.dataURLs;
  },
  getURL: function(n) {
    return this.get()[n].url;
  },
  getFile: function(n) {
    try {
      return this.get()[n].file;
    } catch (e) {
      return null;
    }
    
  },
  getLoadedSoFar: function() {
    return model.loadedSoFar;
  },
  addTagToImgRect: function(tagId, imgId, rectId) {
    model.dataURLs[imgId].rects[rectId].tag = tagId;
  },
  setURL: function(url, n, imageCount) {
    model.loadedSoFar++;
    this.dataURLs[n] = {url: url, rects: [], tags: []};
    this.dataURLs.imageCount = imageCount;
  },
  setFile: function(file, n, imageCount) {
    model.loadedSoFar++;
    this.dataURLs[n] = {file: file, rects: [], tags: []};
    this.dataURLs.imageCount++;
  },
  getName: function(n) {
    return this.get()[n].name;
  },
  setName: function(name, n) {
    this.get()[n].name = name;
  },
  setRect: function(n, trueRect) {
    if (!this.dataURLs[n])
      this.dataURLs[n] = { rects: trueRect };
    else
      this.dataURLs[n].rects = trueRect;
  },
  writeTagSet: function(tagSet) {
    this.dataURLs.tags = tagSet;
  },
  getTagSet: function() {
    return this.dataURLs.tags;
  },
  getTagString: function(tagId) {
    return this.dataURLs.tags[tagId];
  },
  getLength: function() {
    return this.dataURLs.imageCount;
  }
}
var view; // Current view
var filepickingView = {
  panel: $('filepicking-panel'),
  init: function() {
    this.panel.css('display', 'block');
  },
  deinit: function() {
    this.panel.css('display', 'none');
  }
};
var highlightView = {
  currImage: 0,
  initialized: false,
  panel: $('highlighting-panel'),
  init: function() {
    controller.startInitBuffer(0);
    this.panel.css('display', 'block');
    view.applyRectModifiers();
    if (!this.initialized) {
      this.bindEvents();
      this.render();
      this.initialized = true;
    }
  },
  bindEvents: function() {
    $('#nextButton').click(function(event) {
      controller.storeRect(view.currImage);
      view.resetAllRects(true);
      console.log('next0');
      console.log(view.currImage);
      console.log(controller.getLength());
      if (view.currImage+1 < controller.getLength()) {
        view.currImage++;
        console.log('shifting window');
        controller.shiftWindow(1);
      }

      view.render();
    });
    $('#prevButton').click(function(event) {
      controller.storeRect(view.currImage);
      if (view.currImage-1 >= 0) {
        view.currImage--;
        controller.shiftWindow(-1);
      }
      view.render();
    });
    $('#classifyButton').click(function(event) {
      controller.storeRect(view.currImage);
      controller.switchToView(classifyView);
    });
    $('#addRectButton').click(function(event) {
      controller.addRect();
    });
    $('#getDownloadLink').click(function(event) {
      controller.showDownloadLink();
    });
    $('#selectorImage').click(function(event) {
      console.log('adding rect');
      view.addRectCenteredAt(event.pageX, event.pageY, defaultSquareRadius);
    });
    $(document).keydown(function(event) {
      function subtractRadius(ind, val) {
        return parseFloat(val) - radiusResizeIncrement;
      }
      function subtract2Radius(ind, val) {
        return subtractRadius(0, subtractRadius(ind, val));
      }
      function addRadius(ind, val) {
        return parseFloat(val) + radiusResizeIncrement;
      }
      function add2Radius(ind, val) {
        return addRadius(0, addRadius(ind, val));
      }
      switch (event.which) {
        case 80: // 'p'
          $('.selection-square:focus').css('top', subtractRadius)
            .css('left', subtractRadius)
            .css('width', add2Radius)
            .css('height', add2Radius);
          break;
        case 79: // 'o'
          $('.selection-square:focus').css('top', addRadius)
            .css('left', addRadius)
            .css('width', subtract2Radius)
            .css('height', subtract2Radius);
          break;
        case 73: // 'i'
          $('#nextButton').click();
          break;
        case 85: // 'u'
          $('#prevButton').click();
          break;
        case 222: // "'"
          $('#getDownloadLink').click();
          break;
        case 13: // "enter"
          $('#downloadLink').click();
          break;
      }
    });
    $('.selection-square').dblclick(function(event) {
      this.remove();
    });
  },

  deinit: function() {
    this.panel.hide();
  },
  dataUrlOfCrop: function(rect) {
    var cvv = $('#cropper')[0];
    var img = $('#selectorImage')[0];
    cvv.width = rect.width;
    cvv.height = rect.height;
    var cv = cvv.getContext('2d');
    cv.drawImage(img, rect.left, rect.top, rect.width, rect.height, 0, 0, cvv.width, cvv.height);
    return cvv.toDataURL();
  },
  getRects: function() {
    controller.resetDimensions();
    var $sqs = $('.selection-square');
    var rects = [];
    $sqs.each(function(i) {
      var $sq = $(this);
      var pos = $sq.offset();
      pos.left = view.rx(pos.left);
      pos.top = view.ry(pos.top);
      var rect = {
        top: pos.top * imgDimensions[1] / selectorImage.height,
        left: pos.left * imgDimensions[0] / selectorImage.width,
        width: parseFloat($sq.css('width')) * imgDimensions[0] / selectorImage.width,
        height: parseFloat($sq.css('height')) * imgDimensions[1] / selectorImage.height,
      };
      rect.url = view.dataUrlOfCrop(rect);
      rect.realWidth = parseFloat($sq.css('width'));
      rect.realHeight = parseFloat($sq.css('height'));
      rects.push(rect);
    });
    return rects;
  },
  setRects: function() {
    view.resetAllRects(true);
    var imgObj = controller.getImageObject(view.currImage);
    var panel = $('highlighting-panel');
    var rect;
    for (var i = 0; i < imgObj.rects.length; i++) {
      rect = imgObj.rects[i];
      var newRect = $('<div class="selection-square"></div>');
      newRect.css({
        'width': view.realToScaledX(rect.width),
        'height': view.realToScaledY(rect.height),
        'top': view.storedToTrueY(rect.top),
        'left': view.storedToTrueX(rect.left),
      });
      panel.prepend(newRect);
    }
    view.applyRectModifiers();
  },
  addRectCenteredAt: function(x, y, radius) {
    var trueLeft = x - radius;
    var trueTop = y - radius;
    view.drawAndFocusRect(trueLeft, trueTop, radius * 2, radius * 2);
  },
  drawAndFocusRect: function(x, y, width, height) {
    var toPrepend = $('<div class="selection-square"></div>');
    toPrepend.css({
      'width': width,
      'height': height,
      'top': y,
      'left': x,
    });
    $('highlighting-panel').prepend(toPrepend);
    setTimeout(function() {
      toPrepend.get(0).focus();
    }, 10);

    view.applyRectModifiers();
  },
  showDownloadLink: function(url) {
    $('#downloadLink').attr('href', url);
    $('#downloadLink').show();
  },
  render: function() {
    $('#selectorImage').attr('src', controller.getURL());
    view.setRects();
  },
  rx: function(x) {
    return x - selectorImage.offsetLeft;
  },
  ry: function(y) {
    console.log('using scrollTop')
    return y - selectorImage.offsetTop;
  },
  trueX: function(x) {
    return x + selectorImage.offsetLeft;
  },
  trueY: function(y) {
    return y + selectorImage.offsetTop;
  },
  realToScaledX: function(dim) {
    controller.resetDimensions();
    return dim * selectorImage.width / imgDimensions[0];
  },
  scaledToRealX: function(dim) {
    controller.resetDimensions();
    return dim * imgDimensions[0] / selectorImage.width;
  },
  realToScaledY: function(dim) {
    controller.resetDimensions();
    return dim * selectorImage.height / imgDimensions[1];
  },
  scaledToRealY: function(dim) {
    controller.resetDimensions();
    return dim * imgDimensions[1] / selectorImage.height;
  },
  storedToTrueX: function(dim) {
    return view.trueX(view.realToScaledX(dim));
  },
  storedToTrueY: function(dim) {
    return view.trueY(view.realToScaledY(dim));
  },
  addRect: function() {
    $('highlighting-panel').prepend(
      '<div class="selection-square"></div>'
    );
    view.applyRectModifiers();
  },
  applyRectModifiers: function() {
    $('.selection-square').draggable().resizable();
    $('.selection-square').dblclick(function(event) {
      this.remove();
    });
    $('.selection-square').attr('tabindex', '-1');
  },
  resetAllRects: function(noAdd) {
    $('.selection-square').each(function(index) {
      $(this).remove();
    });
    if (!noAdd)
      view.addRect();
  }
};
var classifyView = {
  panel: $('classify-panel'),
  init: function() {
    this.panel.css('display', 'block');
    
    this.render();
    this.applyModifiers();
    this.applyEventHandlers();
  },
  deinit: function() {
    this.panel.css('display', 'none');
  },
  render: function() {
    var grid = $('.image-grid');
    grid.empty();
    for (var n = 0; n < controller.getLength(); n++) {
      console.log('imaging');
      for (var i = 0, rects = controller.rectsForImg(n); i < rects.length; i++) {
        var thumbnail = $('<div class="thumbnail" data-tooltip="No tags set"></div>');
        thumbnail.attr('data-imgid', n);
        thumbnail.attr('data-rectid', i);
        thumbnail.css({
          'height': rects[i].realHeight * 2,
          'width': rects[i].realWidth * 2,
        });
        grid.append(thumbnail);
        thumbnail.css('background-image', u.cssURL(rects[i].url));

      }
    }
    var tagList = $('.tag-list');
    tagList.empty();
    controller.getTagSet().forEach(function(tag, id) {
      var tagSpan = $('<button class="btn btn-default tag-btn"></button>');
      tagSpan.text(tag);
      tagSpan.attr('data-tagid', id);
      tagList.append(tagSpan);
      tagSpan.css('color', 'white');
      tagSpan.css('background-color', u.getColor(id));
    });
  },
  tagBtn: function(tagString, tagId) {
    var tagSpan = $('<button class="btn btn-default tag-btn"></button>');
    tagSpan.text(tagString);
    tagSpan.attr('data-tagid', tagId);
    tagSpan.css('background-color', u.getColor(tagId));
    return tagSpan;
  },
  realToScaledX: function(x) {
    return $('.image-grid').attr('width') / 10;
  },
  renderTooltip: function(thumbId) {
    var thumbElem = view.getThumb(thumbId);
    var tooltipContent = "";
    controller.tagsForImage(thumbId).forEach(function(tagId) {
      tooltipContent += view.tagBtn(controller.tagString(tagId), tagId)[0].outerHTML;
    });
    thumbElem.attr('data-tooltip', tooltipContent);
    thumbElem.tooltip();
  },
  getThumb: function(id) {
    return $('.thumb[data-imgid=' + id + ']');
  },
  addTagToThumbnail: function(tagElem, thumbElem) {
//     var newTitle = thumbElem.attr('data-tooltip') + tagElem[0].outerHTML;
//     console.log('new title '+newTitle);
//     thumbElem.attr('data-tooltip', newTitle);
//     thumbElem.tooltip();
    thumbElem.remove();
//     Eventually make this add HTML to display tag BADGE, not just text
  },
  tagSelected: function(tagElem) {
    $('.ui-selected').each(function() {
      controller.applyTagToThumbnail(tagElem, $(this));
    });
  },
  applyModifiers: function() {
    $.widget("ui.tooltip", $.ui.tooltip, {
      options: {
        content: function () {
          return $(this).attr('data-tooltip');
        }
      }
    });
    $('.image-grid').selectable();
    $('.thumbnail').each(function() {
      $(this).tooltip();
    });
  },
  applyEventHandlers: function() {
    $('.tag-btn').click(function(event) {
      view.tagSelected($(this));
    });
    $('#boxButton').click(function(event) {
      controller.switchToView(highlightView);
    });
  }
};
var u = {
  COLORS: [
    "A32929", "B1365F", "7A367A", "5229A3", "29527A", "2952A3", "1B887A",
    "28754E", "0D7813", "528800", "88880E", "AB8B00", "BE6D00", "B1440E",
    "865A5A", "705770", "4E5D6C", "5A6986", "4A716C", "6E6E41", "8D6F47",
    "853104", "691426", "5C1158", "23164E", "182C57", "060D5E", "125A12",
    "2F6213", "2F6309", "5F6B02", "875509", "8C500B", "754916", "6B3304",
    "5B123B", "42104A", "113F47", "333333", "0F4B38", "856508", "711616",
  ],
  cssURL: function(url) {
    return 'url(' + url + ')';
  },
  getRandomColor: function() {
    // 30 random hues with step of 12 degrees
    var hue = Math.floor(Math.random() * 30) * 12;

    return $.Color({
      hue: hue,
      saturation: 0.9,
      lightness: 0.6,
      alpha: 1
    }).toHexString();
  },
  getColor: function(n) {
    return '#'+u.COLORS[n];
  }

};
var controller = {
  fileToUrlMap: {},
  loadedSoFar: 0,
  fileWindow: [],
  bufferLoaded: false,
  bufferCenterModelId: 0,
  init: function() {
    view = filepickingView;
    model.init();
    view.init();
  },
  startInitBuffer: function(n) {
    for (var i = n-buffer, j=0; i < n+buffer; i++, j++) {
      if (model.getFile(i)) {
        this.fileWindow.push(model.getFile(i));
      } else {
        this.fileWindow.push(null);
      }
    }
    for (var i = 0; i < this.fileWindow.length; i++) {
      var file = this.fileWindow[i];
      if (file) {
        var fr = new FileReader();
        fr.onload = controller.addToMapFunction(file);
        console.log('reading file '+file.name);
        fr.readAsDataURL(file);
      } else {
        controller.fileToUrlMap[null] = null;
      }
    }
  },
  switchToView: function(newView) {
    view.deinit();
    view = newView;
    newView.init();
  },
  getURL: function() {
    console.log(this.fileWindow[buffer].webkitRelativePath);
    console.log(this.fileToUrlMap[this.fileWindow[buffer].webkitRelativePath].substr(0, 8))
    return this.fileToUrlMap[this.fileWindow[buffer].webkitRelativePath];    
  },
  addToMapFunction: function(file) {
    return function(e) {
      console.log('writing file '+file.name);
      controller.fileToUrlMap[file.webkitRelativePath] = e.target.result;
    }
  },
  readToMap: function(file) {
    var fr = new FileReader();
    fr.onload = this.addToMapFunction(file);
    fr.readAsDataURL(file);
  },
  shiftWindow: function(dir) {
    var fl;
    if (dir > 0) {
      fl = model.getFile(this.bufferCenterModelId + buffer);
      this.fileWindow.push(fl);
      // ADD ACTUAL FILE READING HERE
      this.readToMap(fl)
      this.bufferCenterModelId++;
      delete this.fileToUrlMap[this.fileWindow.shift().webkitRelativePath];
    } else if (dir < 0) {
      fl = model.getFile(this.bufferCenterModelId - buffer - 1);
      this.fileWindow.unshift(fl);
      this.readToMap(fl);
      this.bufferCenterModelId--;
      delete this.fileToUrlMap[this.fileWindow.pop().webkitRelativePath];
    }
  },
  getNextURL: function(dir) {
    this.shiftWindow(dir);
    return this.getURL();
  },
  addURL: function(url, n, totalExpected, name) {
    model.setURL(url, n, totalExpected);
    model.setName(name, n);
    if (model.getLoadedSoFar() == totalExpected) {
      return true; // for processDone
    }
  },
  addImg: function(file, n, name) {
    model.setFile(file, n);
    model.setName(name, n);
  },
  getImageObject: function(n) {
    return model.get()[n];
  },
  getLength: function() {
    return model.getLength();
  },
  storeRect: function(n) {
    model.setRect(n, view.getRects());
  },
  //   addRect: function() {
  //     view.addRect();
  //   },
  showDownloadLink: function() {
    // to copy it completely
    var writeObject = JSON.parse(JSON.stringify(model.get()));
    delete writeObject.tags;
    for (var n in writeObject) {
      if (!isNaN(n)) {
        var img = writeObject[n];
        for (var j in img.rects) {
          delete img.rects[j].url;
          img.rects[j].tag = model.getTagString(img.rects[j].tag);
        }
        delete writeObject[n].url;
      }
    }
    
    var url = 'data:application/json,' + 
        encodeURIComponent(JSON.stringify(writeObject));
    view.showDownloadLink(url);
  },
  resetDimensions: function() {
    $('#selectorImage').css('max-width', 'initial');
    imgDimensions[0] = selectorImage.width;
    imgDimensions[1] = selectorImage.height;
    $('#selectorImage').css('max-width', '100%');
  },
  writeTagSet: function(tagSet) {
    model.writeTagSet(tagSet);
  },
  getTagSet: function() {
    return model.getTagSet();
  },
  tagsForImg: function(n) {
    return model.get()[n].tags;
  },
  rectsForImg: function(n) {
    return model.get()[n].rects;
  },
  tagStrings: function(ids) {
    var strings = [];
    ids.forEach(function (id) {
      strings.push(model.getTagString(id));
    })
    return strings;
  },
  applyTagToThumbnail: function(tagElem, thumb) {
    var imgId = thumb.attr('data-imgid');
    var rectId = thumb.attr('data-rectid');
    var tagId = tagElem.attr('data-tagid');
    model.addTagToImgRect(tagId, imgId, rectId);
    view.addTagToThumbnail(tagElem, thumb);
  }
}
controller.init();
</script></body>
</html>
